<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Key System</title>
</head>
<body>
  <div id="step1">
    <h1>Step 1: Click below to proceed to Linkvertise</h1>
    <button id="linkvertiseBtn">Go to Linkvertise</button>
  </div>

  <div id="step2" style="display:none;">
    <h1>Step 2: Generate Key</h1>
    <button id="generateKeyBtn">Generate Key</button>
    <p id="keyOutput"></p>
  </div>

  <script>
    window.onload = () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        document.body.innerHTML = '<h1>Missing token in URL.</h1>';
        return;
      }

      // Auto send token to backend immediately
      (async () => {
        try {
          await fetch('/api/addToken', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
          });
          console.log("Token registered with backend.");
        } catch (e) {
          console.error("Failed to register token:", e);
        }
      })();

      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const linkvertiseBtn = document.getElementById('linkvertiseBtn');
      const generateKeyBtn = document.getElementById('generateKeyBtn');
      const keyOutput = document.getElementById('keyOutput');

      // Show Step 2 directly since token exists
      step1.style.display = 'none';
      step2.style.display = 'block';

      linkvertiseBtn.onclick = () => {
        window.open('https://linkvertise.com/', '_blank');
        step1.style.display = 'none';
        step2.style.display = 'block';
      };

      generateKeyBtn.onclick = async () => {
        keyOutput.innerText = "Generating key...";

        try {
          const res = await fetch('/api/generateKey', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token }),
          });

          const data = await res.json();

          if (data.key) {
            keyOutput.innerText = "Your Key: " + data.key;
          } else {
            keyOutput.innerText = "Error: " + (data.error || "Unknown error");
          }
        } catch (e) {
          keyOutput.innerText = "Network error.";
        }
      };
    };
  </script>
</body>
</html>
